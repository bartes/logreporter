%html{:xmlns => "http://www.w3.org/1999/xhtml", "xml:lang" => "en", :lang => "en"}
  %head
    %script{:language => "javascript", :type => "text/javascript", :src => "jquery-1.5.2.min.js"}
    %script{:language => "javascript", :type => "text/javascript", :src => "jquery.flot.min.js"}
    :css
      body {
        font: normal 11px auto "Trebuchet MS", Verdana, Arial, Helvetica, sans-serif;
        color: #4f6b72;
        background: #E6EAE9;
        padding-left:20px;
        padding-top:20px;
        padding-bottom:20px;
      }

      a {
        color: #c75f3e;
      }

      .color_bar {
        border: 1px solid;
        height:10px;
        background: #CAE8EA;
      }

      #mytable {
        width: 700px;
        padding: 0;
        margin: 0;
        padding-bottom:10px;
      }

      caption {
        padding: 0 0 5px 0;
        width: 700px;
        font: italic 11px "Trebuchet MS", Verdana, Arial, Helvetica, sans-serif;
        text-align: right;
      }

      th {
        font: bold 11px "Trebuchet MS", Verdana, Arial, Helvetica, sans-serif;
        color: #4f6b72;
        border-right: 1px solid #C1DAD7;
        border-bottom: 1px solid #C1DAD7;
        border-top: 1px solid #C1DAD7;
        letter-spacing: 2px;
        text-transform: uppercase;
        text-align: left;
        padding: 6px 6px 6px 12px;
        background: #CAE8EA no-repeat;
      }

      td {
        font: bold 11px "Trebuchet MS", Verdana, Arial, Helvetica, sans-serif;
        border-right: 1px solid #C1DAD7;
        border-bottom: 1px solid #C1DAD7;
        background: #fff;
        padding: 6px 6px 6px 12px;
        color: #4f6b72;
      }

      td.alt {
        background: #F5FAFA;
        color: #797268;
      }
      .chart{
        margin: 10px 0 0 10px
      }
  %body
    %h1 Logreporter's summary
    %h2
    - items.each_pair do |month_year, daily_items|
      %h2= "Average rates for #{month_year.last}-#{month_year.first}"
      %table{:cellspacing => 0}
        %tbody
          %tr
            %th day
            - daily_items.each do |daily_item|
              - title = "Particular report for #{daily_item.year}.#{daily_item.month}.#{daily_item.day}"
              - href = "#{daily_item.year}#{"%02d" % daily_item.month}#{"%02d" % daily_item.day}.html"
              %th
                %a{:href => href, :title => title}
                  %span= daily_item.day
          %tr
            %td Number of requests
            - daily_items.each do |daily_item|
              %td.dayItemNoRequests{:"data-day" => [daily_item.data["date"].split(" ").first, "#{daily_item.day}.#{daily_item.month}.#{daily_item.year}"], :"data-value" => daily_item.data["no_of_requests"].round(3) }
                = daily_item.data["no_of_requests"]
          %tr
            %td.alt Request duration
            - daily_items.each do |daily_item|
              %td.alt.dayItemRequest{:"data-day" => [daily_item.data["date"].split(" ").first, "#{daily_item.day}.#{daily_item.month}.#{daily_item.year}"], :"data-value" => daily_item.data["duration_average"].round(3) }
                = "#{daily_item.data["duration_average"].round(2)}s"
          %tr
            %td View rendering duration
            - daily_items.each do |daily_item|
              %td.dayItemView{:"data-day" => [daily_item.data["date"].split(" ").first, "#{daily_item.day}.#{daily_item.month}.#{daily_item.year}"], :"data-value" => daily_item.data["view_average"].round(3) }
                = "#{daily_item.data["view_average"].round(2)}s"
          %tr
            %td.alt Database response duration
            - daily_items.each do |daily_item|
              %td.alt.dayItemDb{:"data-day" => [daily_item.data["date"].split(" ").first, "#{daily_item.day}.#{daily_item.month}.#{daily_item.year}"], :"data-value" => daily_item.data["db_average"].round(3) }
                = "#{daily_item.data["db_average"].round(2)}s"

    - {:NoRequests => "Number of requests per day", :Request => "Average request duration", :View => "Average view rendering time", :Db => "Average database response time"}.each_pair do |id, headline|
      %h2= headline
      %div{:class => "chart", :id => "chart#{id}", :style => "width:800px;height:300px;"}

    :javascript
      $(function () {
          function showTooltip(x, y, contents) {
              $('<div id="tooltip">' + contents + '</div>').css( {
                  position: 'absolute',
                  display: 'none',
                  top: y + 5,
                  left: x + 5,
                  border: '1px solid #fdd',
                  padding: '2px',
                  'background-color': '#fee',
                  opacity: 0.80
              }).appendTo("body").fadeIn(200);
          };
          var result_charts = {
            NoRequests: "Requests per day",
            Request:    "Average request duration (s)",
            View:       "Average view rendering time (s)",
            Db:         "Average database response time (s)"
          };

          for(key in result_charts) {
            var chart_data = [];
            var xticks = [];
            $.each($(".dayItem"+key).sort(function(i){return $(i).data("day");}), function(){
               xticks.push([Date.parse($(this).data("day")[0]), $(this).data("day")[1]])
               chart_data.push( [Date.parse($(this).data("day")[0]), $(this).data("value")]);
            });
            var options = {
                lines: { show: true },
                points: { show: true },
                xaxis: {
                  ticks: [xticks[0]]
                },
                grid: { hoverable: true }
            };
            var previousPoint = null
            $.plot($("#chart"+key), [{label: result_charts[key], data: chart_data}], options);
            $("#chart"+key).bind("plothover", function (event, pos, item) {
              if (item) {
                  if (previousPoint != item.dataIndex) {
                      previousPoint = item.dataIndex;
                      $("#tooltip").remove();
                      var x = item.datapoint[0],
                          y = item.datapoint[1].toFixed(2);
                      var date = new Date(x);
                      showTooltip(item.pageX, item.pageY,
                                  item.series.label + " from "+ date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear() + " is " + y);
                  }
              }
              else {
                  $("#tooltip").remove();
                  previousPoint = null;
              }
            });
          }

      });


